<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UNet Segmentation Demo</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #upload-box {
      border: 2px dashed #888;
      padding: 40px;
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      cursor: pointer;
    }
    #upload-box.hover {
      border-color: #444;
      color: #444;
    }
    #canvasContainer {
      position: relative;
      display: inline-block;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    #legend {
      margin-top: 20px;
      display: none;
    }
    .legend-item {
      display: inline-block;
      margin-right: 15px;
      margin-bottom: 5px;
    }
    .color-box {
      display: inline-block;
      width: 15px;
      height: 15px;
      margin-right: 5px;
      vertical-align: middle;
    }
  </style>
</head>
<body>

  <h2>UNet 语义分割演示</h2>

  <div id="upload-box">
    拖放或点击上传图片<br>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
  </div>

  <div id="canvasContainer" style="display:none">
    <canvas id="imageCanvas"></canvas>
    <canvas id="maskCanvas"></canvas>
  </div>
  
  <div id="legend"></div>

  <script>
    // VOC 2012 类别映射
    const VOC_CLASSES = [
      'background','aeroplane','bicycle','bird','boat',
      'bottle','bus','car','cat','chair',
      'cow','diningtable','dog','horse','motorbike',
      'person','pottedplant','sheep','sofa','train','tvmonitor'
    ];
    
    // VOC 颜色映射 (21个类别，包括背景)
    const VOC_COLORMAP = [
      [0, 0, 0],        // background
      [128, 0, 0],      // aeroplane
      [0, 128, 0],      // bicycle
      [128, 128, 0],    // bird
      [0, 0, 128],      // boat
      [128, 0, 128],    // bottle
      [0, 128, 128],    // bus
      [128, 128, 128],  // car
      [64, 0, 0],       // cat
      [192, 0, 0],      // chair
      [64, 128, 0],     // cow
      [192, 128, 0],    // diningtable
      [64, 0, 128],     // dog
      [192, 0, 128],    // horse
      [64, 128, 128],   // motorbike
      [192, 128, 128],  // person
      [0, 64, 0],       // pottedplant
      [128, 64, 0],     // sheep
      [0, 192, 0],      // sofa
      [128, 192, 0],    // train
      [0, 64, 128]      // tvmonitor
    ];

    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('fileInput');
    const canvasContainer = document.getElementById('canvasContainer');
    const imageCanvas = document.getElementById('imageCanvas');
    const maskCanvas = document.getElementById('maskCanvas');
    const legendDiv = document.getElementById('legend');

    let maskData = null;
    let imgWidth = 0, imgHeight = 0;

    // 事件绑定
    uploadBox.addEventListener('click', () => fileInput.click());
    uploadBox.addEventListener('dragover', e => {
      e.preventDefault();
      uploadBox.classList.add('hover');
    });
    uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('hover'));
    uploadBox.addEventListener('drop', e => {
      e.preventDefault();
      uploadBox.classList.remove('hover');
      handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

    function handleFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => processImage(img);
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    }

    function processImage(img) {
      imgWidth = img.width;
      imgHeight = img.height;
      [imageCanvas, maskCanvas].forEach(cv => {
        cv.width = imgWidth;
        cv.height = imgHeight;
      });
      // 绘制原始图像
      const ctx = imageCanvas.getContext('2d');
      ctx.clearRect(0, 0, imgWidth, imgHeight);
      ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

      // 显示画布容器
      canvasContainer.style.display = 'inline-block';

      // 发送到后端
      sendToBackend();
    }

    function sendToBackend() {
      imageCanvas.toBlob(blob => {
        const form = new FormData();
        form.append('file', blob, 'input.png');
        fetch('http://127.0.0.1:8000/predict', { method: 'POST', body: form })
          .then(res => res.json())
          .then(json => {
            maskData = json.mask;  // 获取预测的掩码数据
            // 检查掩码中有哪些类别
            const uniqueValues = new Set(maskData);
            console.log("掩码中的唯一值:", Array.from(uniqueValues));
            drawMask(json.class_confidences); // 传递类别置信度给drawMask
          })
          .catch(err => {
            console.error('预测失败', err);
            alert('模型推理失败，请检查后端/predict接口');
          });
      });
    }

    function drawMask(classConfidences = {}) {
      const ctx = maskCanvas.getContext('2d');
      const imgData = ctx.createImageData(imgWidth, imgHeight);
      
      // 先清空画布
      ctx.clearRect(0, 0, imgWidth, imgHeight);
      
      // 使用与训练集相同的颜色映射填充掩码
      for (let i = 0, len = maskData.length; i < len; i++) {
        const classId = maskData[i];
        if (classId > 0) { // 跳过背景类(0)
          const j = i * 4;
          const color = VOC_COLORMAP[classId];
          imgData.data[j + 0] = color[0]; // R
          imgData.data[j + 1] = color[1]; // G
          imgData.data[j + 2] = color[2]; // B
          imgData.data[j + 3] = 180;      // 0.7 alpha
        }
      }
      
      ctx.putImageData(imgData, 0, 0);
      
      // 生成图例
      generateLegend(classConfidences);
    }
    
    function generateLegend(classConfidences) {
      // 清空当前图例
      legendDiv.innerHTML = '';
      
      // 获取图像中存在的类别
      const presentClasses = new Set(maskData);
      presentClasses.delete(0); // 移除背景类别
      
      if (presentClasses.size) {
        legendDiv.style.display = 'block';
        presentClasses.forEach(classId => {
          const color = VOC_COLORMAP[classId];
          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          
          const colorBox = document.createElement('span');
          colorBox.className = 'color-box';
          colorBox.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
          
          const className = document.createElement('span');
          className.textContent = VOC_CLASSES[classId];
          
          const confidence = document.createElement('span');
          confidence.textContent = ` (${(classConfidences[classId] * 100).toFixed(2)}%)`;
          
          legendItem.appendChild(colorBox);
          legendItem.appendChild(className);
          legendItem.appendChild(confidence);
          
          legendDiv.appendChild(legendItem);
        });
      } else {
        legendDiv.style.display = 'none';
      }
    }
  </script>
</body>
</html>
<!-- End of demo.html -->